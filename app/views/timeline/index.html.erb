<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
  <!-- Header -->
  <div class="mb-8">
    <h1 class="text-3xl font-bold text-brown decorative-heading">Timeline</h1>
    <p class="mt-2 text-brown-light">Your travel schedule at a glance</p>
  </div>

  <% if @stays.any? %>
    <!-- Zoom Controls -->
    <div class="mb-4 flex items-center gap-4">
      <span class="text-sm text-brown-light">View:</span>
      <div class="flex gap-2">
        <%= link_to timeline_path(zoom: "3m"),
            class: "timeline-zoom-btn #{@zoom == '3m' ? 'active' : ''}",
            data: { turbo_action: "replace" } do %>
          3 Months
        <% end %>
        <%= link_to timeline_path(zoom: "year"),
            class: "timeline-zoom-btn #{@zoom == 'year' ? 'active' : ''}",
            data: { turbo_action: "replace" } do %>
          This Year
        <% end %>
        <%= link_to timeline_path(zoom: "all"),
            class: "timeline-zoom-btn #{@zoom == 'all' ? 'active' : ''}",
            data: { turbo_action: "replace" } do %>
          All Time
        <% end %>
      </div>
    </div>

    <!-- Legend -->
    <div class="mb-6 flex flex-wrap items-center gap-x-6 gap-y-2 text-sm">
      <div class="flex items-center gap-2">
        <div class="w-4 h-4 rounded-full bg-sage"></div>
        <span class="text-brown-light">Upcoming</span>
      </div>
      <div class="flex items-center gap-2">
        <div class="w-4 h-4 rounded-full bg-rose"></div>
        <span class="text-brown-light">Current</span>
      </div>
      <div class="flex items-center gap-2">
        <div class="w-4 h-4 rounded-full bg-taupe"></div>
        <span class="text-brown-light">Past</span>
      </div>
      <div class="flex items-center gap-2">
        <div class="w-4 h-4 rounded-full bg-lavender border-2 border-dashed border-lavender-dark"></div>
        <span class="text-brown-light">Planned</span>
      </div>
      <div class="flex items-center gap-2">
        <div class="w-4 h-4 rounded-full timeline-gap-legend"></div>
        <span class="text-brown-light">Gap</span>
      </div>
      <div class="flex items-center gap-2">
        <div class="w-0.5 h-4 bg-rose-dark"></div>
        <span class="text-brown-light">Today</span>
      </div>
    </div>

    <!-- Year Calendar Grid -->
    <% @year_calendar.each do |year_data| %>
      <div class="cozy-card p-4 sm:p-6 mb-6">
        <h2 class="text-2xl font-bold text-brown mb-4"><%= year_data[:year] %></h2>
        <div class="grid grid-cols-3 gap-3 sm:gap-5 mx-auto max-w-3xl">
          <% year_data[:months].each do |month| %>
            <div class="text-center">
              <div class="text-xs font-medium text-brown-light mb-1"><%= month[:name] %></div>
              <div class="grid grid-cols-7 gap-0.5">
                <%# Add empty cells for days before the 1st %>
                <% month[:start_wday].times do %>
                  <div class="w-4 h-4 sm:w-5 sm:h-5"></div>
                <% end %>
                <%# Render each day %>
                <% month[:days].each do |day| %>
                  <% day_class = case day[:status]&.dig(:type)
                                 when 'upcoming' then 'bg-sage'
                                 when 'current' then 'bg-rose'
                                 when 'past' then 'bg-taupe'
                                 when 'planned' then 'bg-lavender'
                                 when 'gap' then 'year-calendar-gap'
                                 else 'bg-taupe-light'
                                 end %>
                  <% today_class = day[:status]&.dig(:today) ? 'ring-1 ring-rose-dark' : '' %>
                  <div class="w-4 h-4 sm:w-5 sm:h-5 rounded-sm <%= day_class %> <%= today_class %>"></div>
                <% end %>
              </div>
            </div>
          <% end %>
        </div>
      </div>
    <% end %>

    <!-- Timeline Container -->
    <div class="cozy-card p-6 overflow-hidden"
         data-controller="timeline"
         data-timeline-start-value="<%= @start_date.to_s %>"
         data-timeline-end-value="<%= @end_date.to_s %>"
         data-timeline-today-value="<%= @today.to_s %>">

      <!-- Month Headers -->
      <div class="relative mb-4 border-b border-taupe-light pb-2 overflow-x-auto timeline-scroll-container" data-timeline-target="header">
        <div class="flex" style="min-width: <%= [@total_days * 4, 800].max %>px;">
          <% current_month = @start_date.beginning_of_month %>
          <% while current_month <= @end_date %>
            <% month_start = [current_month, @start_date].max %>
            <% month_end = [current_month.end_of_month, @end_date].min %>
            <% month_days = (month_end - month_start).to_i + 1 %>
            <% width_percent = (month_days.to_f / @total_days * 100).round(2) %>
            <% # Abbreviate month name for narrow widths %>
            <% month_label = width_percent < 8 ? current_month.strftime('%b') : current_month.strftime('%B %Y') %>
            <% month_label = "" if width_percent < 3 %>
            <div style="width: <%= width_percent %>%; min-width: 0;" class="text-center text-sm font-medium text-brown truncate px-1">
              <%= month_label %>
            </div>
            <% current_month = current_month.next_month.beginning_of_month %>
          <% end %>
        </div>
      </div>

      <!-- Timeline Track (scrollable) -->
      <div class="relative overflow-x-auto timeline-scroll-container cursor-grab active:cursor-grabbing"
           data-timeline-target="track"
           data-action="mousedown->timeline#startDrag mousemove->timeline#drag mouseup->timeline#stopDrag mouseleave->timeline#stopDrag"
           tabindex="0">
        <div class="relative" style="height: <%= 20 + (@row_count * 66) %>px; min-width: <%= [@total_days * 4, 800].max %>px;">

          <!-- Year Dividers -->
          <% years_in_range = (@start_date.year..@end_date.year).to_a %>
          <% years_in_range.each do |year| %>
            <% year_start = Date.new(year, 1, 1) %>
            <% next if year_start < @start_date || year_start > @end_date %>
            <% year_offset = ((year_start - @start_date).to_f / @total_days * 100).round(2) %>
            <div class="timeline-year-divider" style="left: <%= year_offset %>%;">
              <span class="timeline-year-label"><%= year %></span>
            </div>
          <% end %>

          <!-- Today Marker -->
          <% if @today >= @start_date && @today <= @end_date %>
            <% today_offset = ((@today - @start_date).to_f / @total_days * 100).round(2) %>
            <div class="absolute top-0 bottom-0 w-0.5 bg-rose-dark z-20"
                 style="left: <%= today_offset %>%;"
                 data-timeline-target="todayMarker">
              <div class="absolute -top-6 -translate-x-1/2 text-xs font-medium text-rose-dark whitespace-nowrap">
                Today
              </div>
            </div>
          <% end %>

          <!-- Timeline Items (Stays and Gaps interleaved on single row) -->
          <% @timeline_items.each_with_index do |item, index| %>
            <% # Skip items outside visible range %>
            <% next if item[:end_date] < @start_date || item[:start_date] > @end_date %>

            <% # Clamp dates to visible range %>
            <% visible_start = [item[:start_date], @start_date].max %>
            <% visible_end = [item[:end_date], @end_date].min %>
            <% left_offset = ((visible_start - @start_date).to_f / @total_days * 100).round(2) %>
            <% width = ((visible_end - visible_start).to_f / @total_days * 100).round(2) %>

            <% if item[:type] == :stay %>
              <% stay = item[:object] %>
              <% if stay.booked? %>
                <% bar_class = case stay.status
                              when 'upcoming' then 'timeline-bar-upcoming'
                              when 'current' then 'timeline-bar-current'
                              when 'past' then 'timeline-bar-past'
                              end %>
              <% else %>
                <% bar_class = 'timeline-bar-planned' %>
              <% end %>

              <!-- Connecting line to next stay -->
              <% next_stay_item = @timeline_items[index + 1..].find { |i| i[:type] == :stay } %>
              <% if next_stay_item %>
                <% next_visible_start = [next_stay_item[:start_date], @start_date].max %>
                <% if next_visible_start > visible_end && next_visible_start <= @end_date %>
                  <% line_start = ((visible_end - @start_date).to_f / @total_days * 100).round(2) %>
                  <% line_end = ((next_visible_start - @start_date).to_f / @total_days * 100).round(2) %>
                  <div class="timeline-connector" style="left: <%= line_start %>%; width: <%= line_end - line_start %>%;"></div>
                <% end %>
              <% end %>

              <%= link_to stay_path(stay),
                  class: "timeline-bar #{bar_class} group",
                  style: "left: #{left_offset}%; width: #{width}%; top: #{20 + (item[:row] * 66)}px;",
                  data: {
                    controller: "tooltip",
                    tooltip_content_value: tooltip_content_for(stay),
                    action: "mouseenter->tooltip#show mouseleave->tooltip#hide"
                  } do %>
                <div class="timeline-bar-content">
                  <div class="truncate font-medium text-sm">
                    <%= stay.title %>
                    <% unless stay.booked? %>
                      <span class="text-xs opacity-80">(Planned)</span>
                    <% end %>
                  </div>
                  <div class="truncate text-xs opacity-80">
                    <%= stay.city %>
                  </div>
                </div>
                <div class="timeline-bar-duration">
                  <%= stay.duration_days %>n
                </div>
              <% end %>

            <% else %>
              <!-- Gap -->
              <% gap = item %>
              <%= link_to new_stay_path(check_in: gap[:start_date], check_out: gap[:end_date]),
                  class: "timeline-bar timeline-gap-bar group",
                  style: "left: #{left_offset}%; width: #{width}%; top: #{20 + (item[:row] * 66)}px;",
                  data: {
                    controller: "tooltip",
                    tooltip_content_value: gap_tooltip_content(gap),
                    action: "mouseenter->tooltip#show mouseleave->tooltip#hide"
                  } do %>
                <div class="timeline-bar-content">
                  <div class="truncate font-medium text-sm text-coral-dark"><%= gap[:days] %>d gap</div>
                </div>
              <% end %>
            <% end %>
          <% end %>
        </div>
      </div>

      <!-- Date Labels -->
      <div class="relative mt-4 pt-2 border-t border-taupe-light">
        <div class="flex justify-between text-xs text-brown-light">
          <span><%= @start_date.strftime('%b %d, %Y') %></span>
          <span><%= @end_date.strftime('%b %d, %Y') %></span>
        </div>
      </div>

      <!-- Keyboard hint -->
      <div class="mt-2 text-xs text-brown-lighter text-center">
        Drag to scroll or use arrow keys
      </div>
    </div>

    <!-- Botanical Divider -->
    <div class="botanical-divider">
      <span>All Stays</span>
    </div>

    <!-- Stay List -->
    <div class="mt-8">
      <div class="cozy-card overflow-x-auto cozy-table">
        <table class="min-w-full divide-y divide-taupe-light">
          <thead class="bg-taupe-light">
            <tr>
              <th class="px-6 py-3 text-left text-xs font-medium text-brown uppercase tracking-wider">Stay</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-brown uppercase tracking-wider">Location</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-brown uppercase tracking-wider">Check-in</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-brown uppercase tracking-wider">Check-out</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-brown uppercase tracking-wider">Duration</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-brown uppercase tracking-wider">Status</th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-taupe-light">
            <% @stays.each do |stay| %>
              <tr class="hover:bg-cream transition-colors">
                <td class="px-6 py-4 whitespace-nowrap">
                  <%= link_to stay.title, stay_path(stay), class: "text-sage-dark hover:text-sage font-medium" %>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-brown-light">
                  <%= [stay.city, stay.country].compact.join(', ') %>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-brown-light">
                  <%= stay.check_in.strftime('%b %d, %Y') %>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-brown-light">
                  <%= stay.check_out.strftime('%b %d, %Y') %>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-brown-light">
                  <%= stay.duration_days %> nights
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                  <div class="flex items-center gap-2">
                    <% if stay.booked? %>
                      <span class="badge <%= case stay.status
                          when 'upcoming' then 'badge-upcoming'
                          when 'current' then 'badge-current'
                          when 'past' then 'badge-past'
                          end %>">
                        <%= stay.status.capitalize %>
                      </span>
                    <% else %>
                      <span class="badge badge-planned">
                        Planned
                      </span>
                      <%= link_to "Book", edit_stay_path(stay), class: "text-xs text-sage-dark hover:text-sage" %>
                    <% end %>
                  </div>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    </div>
  <% else %>
    <!-- Empty State -->
    <div class="cozy-card p-12 text-center">
      <svg class="mx-auto h-12 w-12 text-taupe" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
      </svg>
      <h3 class="mt-4 text-lg font-medium text-brown">No stays yet</h3>
      <p class="mt-2 text-brown-light">Get started by adding your first stay.</p>
      <div class="mt-6">
        <%= link_to new_stay_path, class: "btn-primary" do %>
          <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
          </svg>
          Add Your First Stay
        <% end %>
      </div>
    </div>
  <% end %>
</div>
