<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
  <!-- Header -->
  <div class="mb-8 flex items-center justify-between">
    <div>
      <h1 class="text-3xl font-bold text-brown decorative-heading">Timeline</h1>
      <p class="mt-2 text-brown-light">Your travel schedule at a glance</p>
    </div>
    <div class="flex gap-3">
      <%= link_to root_path, class: "btn-outline" do %>
        Dashboard
      <% end %>
      <%= link_to map_path, class: "btn-outline" do %>
        Map View
      <% end %>
      <%= link_to new_stay_path, class: "btn-primary" do %>
        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
        </svg>
        Add Stay
      <% end %>
    </div>
  </div>

  <% if @stays.any? %>
    <!-- Legend -->
    <div class="mb-6 flex flex-wrap items-center gap-6 text-sm">
      <div class="flex items-center gap-2">
        <div class="w-4 h-4 rounded-full bg-sage"></div>
        <span class="text-brown-light">Upcoming</span>
      </div>
      <div class="flex items-center gap-2">
        <div class="w-4 h-4 rounded-full bg-rose"></div>
        <span class="text-brown-light">Current</span>
      </div>
      <div class="flex items-center gap-2">
        <div class="w-4 h-4 rounded-full bg-taupe"></div>
        <span class="text-brown-light">Past</span>
      </div>
      <div class="flex items-center gap-2">
        <div class="w-4 h-4 rounded-full bg-lavender border-2 border-dashed border-lavender-dark"></div>
        <span class="text-brown-light">Planned</span>
      </div>
      <div class="flex items-center gap-2">
        <div class="w-4 h-4 rounded-full bg-coral-light border-2 border-dashed border-coral"></div>
        <span class="text-brown-light">Gap</span>
      </div>
      <div class="flex items-center gap-2">
        <div class="w-0.5 h-4 bg-rose-dark"></div>
        <span class="text-brown-light">Today</span>
      </div>
    </div>

    <!-- Timeline Container -->
    <div class="cozy-card p-6 overflow-x-auto"
         data-controller="timeline"
         data-timeline-start-value="<%= @start_date.to_s %>"
         data-timeline-end-value="<%= @end_date.to_s %>"
         data-timeline-today-value="<%= @today.to_s %>">

      <!-- Month Headers -->
      <div class="relative mb-4 border-b border-taupe-light pb-2">
        <div class="flex">
          <% current_month = @start_date.beginning_of_month %>
          <% while current_month <= @end_date %>
            <% month_start = [current_month, @start_date].max %>
            <% month_end = [current_month.end_of_month, @end_date].min %>
            <% month_days = (month_end - month_start).to_i + 1 %>
            <% width_percent = (month_days.to_f / @total_days * 100).round(2) %>
            <div style="width: <%= width_percent %>%;" class="text-center text-sm font-medium text-brown">
              <%= current_month.strftime('%B %Y') %>
            </div>
            <% current_month = current_month.next_month.beginning_of_month %>
          <% end %>
        </div>
      </div>

      <!-- Timeline Track -->
      <div class="relative" style="height: <%= (@stays.count + @gaps.count) * 60 + 40 %>px;">
        <!-- Today Marker -->
        <% if @today >= @start_date && @today <= @end_date %>
          <% today_offset = ((@today - @start_date).to_f / @total_days * 100).round(2) %>
          <div class="absolute top-0 bottom-0 w-0.5 bg-rose-dark z-20"
               style="left: <%= today_offset %>%;">
            <div class="absolute -top-6 -translate-x-1/2 text-xs font-medium text-rose-dark whitespace-nowrap">
              Today
            </div>
          </div>
        <% end %>

        <!-- Stays -->
        <% row = 0 %>
        <% @stays.each do |stay| %>
          <% left_offset = ((stay.check_in - @start_date).to_f / @total_days * 100).round(2) %>
          <% width = ((stay.check_out - stay.check_in).to_f / @total_days * 100).round(2) %>
          <% if stay.booked? %>
            <% bar_class = case stay.status
                          when 'upcoming' then 'timeline-bar-upcoming'
                          when 'current' then 'timeline-bar-current'
                          when 'past' then 'timeline-bar-past'
                          end %>
            <% border_style = '' %>
          <% else %>
            <% bar_class = 'timeline-bar-planned' %>
            <% border_style = '' %>
          <% end %>
          <%= link_to stay_path(stay), class: "absolute h-12 rounded-2xl #{bar_class} text-white px-3 py-2 shadow-cozy transition-all cursor-pointer overflow-hidden group hover:shadow-cozy-lg", style: "left: #{left_offset}%; width: #{width}%; top: #{row * 60 + 10}px; min-width: 100px;" do %>
            <div class="truncate font-medium text-sm">
              <%= stay.title %>
              <% unless stay.booked? %>
                <span class="text-xs opacity-80">(Planned)</span>
              <% end %>
            </div>
            <div class="truncate text-xs opacity-80">
              <%= stay.city %>
              <span class="hidden group-hover:inline"> - <%= stay.duration_days %> nights</span>
            </div>
          <% end %>
          <% row += 1 %>
        <% end %>

        <!-- Gaps -->
        <% @gaps.each do |gap| %>
          <% left_offset = ((gap[:start_date] - @start_date).to_f / @total_days * 100).round(2) %>
          <% width = ((gap[:end_date] - gap[:start_date]).to_f / @total_days * 100).round(2) %>
          <%= link_to new_stay_path(check_in: gap[:start_date], check_out: gap[:end_date]),
              class: "absolute h-12 rounded-2xl timeline-gap px-3 py-2 hover:bg-coral transition-all cursor-pointer overflow-hidden group",
              style: "left: #{left_offset}%; width: #{width}%; top: #{row * 60 + 10}px; min-width: 80px;" do %>
            <div class="truncate font-medium text-sm text-coral-dark"><%= gap[:days] %> days</div>
            <div class="truncate text-xs text-coral-dark">
              Gap
              <span class="hidden group-hover:inline"> - Click to add stay</span>
            </div>
          <% end %>
          <% row += 1 %>
        <% end %>
      </div>

      <!-- Date Labels -->
      <div class="relative mt-4 pt-2 border-t border-taupe-light">
        <div class="flex justify-between text-xs text-brown-light">
          <span><%= @start_date.strftime('%b %d, %Y') %></span>
          <span><%= @end_date.strftime('%b %d, %Y') %></span>
        </div>
      </div>
    </div>

    <!-- Botanical Divider -->
    <div class="botanical-divider">
      <span>All Stays</span>
    </div>

    <!-- Stay List -->
    <div class="mt-8">
      <div class="cozy-card overflow-hidden cozy-table">
        <table class="min-w-full divide-y divide-taupe-light">
          <thead class="bg-taupe-light">
            <tr>
              <th class="px-6 py-3 text-left text-xs font-medium text-brown uppercase tracking-wider">Stay</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-brown uppercase tracking-wider">Location</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-brown uppercase tracking-wider">Check-in</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-brown uppercase tracking-wider">Check-out</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-brown uppercase tracking-wider">Duration</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-brown uppercase tracking-wider">Status</th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-taupe-light">
            <% @stays.each do |stay| %>
              <tr class="hover:bg-cream/50 transition-colors">
                <td class="px-6 py-4 whitespace-nowrap">
                  <%= link_to stay.title, stay_path(stay), class: "text-sage-dark hover:text-sage font-medium" %>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-brown-light">
                  <%= [stay.city, stay.country].compact.join(', ') %>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-brown-light">
                  <%= stay.check_in.strftime('%b %d, %Y') %>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-brown-light">
                  <%= stay.check_out.strftime('%b %d, %Y') %>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-brown-light">
                  <%= stay.duration_days %> nights
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                  <div class="flex items-center gap-2">
                    <% if stay.booked? %>
                      <span class="badge <%= case stay.status
                          when 'upcoming' then 'badge-upcoming'
                          when 'current' then 'badge-current'
                          when 'past' then 'badge-past'
                          end %>">
                        <%= stay.status.capitalize %>
                      </span>
                    <% else %>
                      <span class="badge badge-planned">
                        Planned
                      </span>
                      <%= link_to "Book", edit_stay_path(stay), class: "text-xs text-sage-dark hover:text-sage" %>
                    <% end %>
                  </div>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    </div>
  <% else %>
    <!-- Empty State -->
    <div class="cozy-card p-12 text-center">
      <svg class="mx-auto h-12 w-12 text-taupe" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
      </svg>
      <h3 class="mt-4 text-lg font-medium text-brown">No stays yet</h3>
      <p class="mt-2 text-brown-light">Get started by adding your first stay.</p>
      <div class="mt-6">
        <%= link_to new_stay_path, class: "btn-primary" do %>
          <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
          </svg>
          Add Your First Stay
        <% end %>
      </div>
    </div>
  <% end %>
</div>
