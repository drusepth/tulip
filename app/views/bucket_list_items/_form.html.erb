<% search_url = place_search_stay_path(stay) if stay.latitude.present? && stay.longitude.present? %>
<%= form_with model: [stay, BucketListItem.new],
             id: "bucket_list_form",
             class: "bucket-list-form",
             data: { controller: "bucket-list-form" } do |f| %>
  <div class="relative">
    <div class="flex flex-col sm:flex-row gap-2">
      <div class="relative flex-1"
           <% if search_url %>
           data-controller="place-mention"
           data-place-mention-search-url-value="<%= search_url %>"
           <% end %>>
        <%= f.text_field :title,
                         placeholder: search_url ? "Add something... (type @ to mention a place)" : "Add something...",
                         class: "w-full px-4 py-2.5 border-2 border-taupe-light rounded-2xl bg-white text-brown placeholder-brown-lighter focus:outline-none focus:border-sage focus:bg-sage-light transition-colors text-sm sm:text-base",
                         data: { bucket_list_form_target: "titleInput" }.merge(
                           search_url ? { place_mention_target: "textarea", action: "input->place-mention#onInput keydown->place-mention#onKeydown" } : {}
                         ) %>
        <% if search_url %>
          <div class="mention-dropdown hidden" data-place-mention-target="dropdown"></div>
        <% end %>
      </div>

      <%= f.submit "Add", class: "btn-primary px-5 w-full sm:w-auto" %>
    </div>

    <!-- Expandable extra fields -->
    <div class="mt-2">
      <button type="button"
              class="text-xs text-brown-light hover:text-sage-dark flex items-center gap-1.5 transition-colors"
              data-action="click->bucket-list-form#toggleExpand"
              data-bucket-list-form-target="expandButton">
        <svg class="w-3 h-3 transform transition-transform" data-bucket-list-form-target="expandIcon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
        </svg>
        <span data-bucket-list-form-target="expandLabel">More options</span>
      </button>

      <div class="hidden mt-3 pl-4 border-l-2 border-taupe-light space-y-3" data-bucket-list-form-target="extraFields">
        <div>
          <label class="text-xs font-medium text-brown-light mb-1 block">
            Location
          </label>
          <%= f.text_field :address,
                           placeholder: "Where is it?",
                           class: "w-full px-3 py-2 text-sm border border-taupe-light rounded-xl bg-white text-brown placeholder-brown-lighter focus:outline-none focus:border-sage" %>
        </div>
        <div>
          <label class="text-xs font-medium text-brown-light mb-1 block">
            Notes
          </label>
          <%= f.text_area :notes,
                          placeholder: "Any details to remember...",
                          rows: 2,
                          class: "w-full px-3 py-2 text-sm border border-taupe-light rounded-xl bg-white text-brown placeholder-brown-lighter focus:outline-none focus:border-sage resize-none" %>
        </div>
      </div>
    </div>
  </div>
<% end %>
