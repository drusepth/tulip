<div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-8" data-controller="gallery-filter gallery-pagination"
     data-gallery-pagination-stay-id-value="<%= @stay.id %>"
     data-gallery-pagination-current-page-value="<%= @page %>"
     data-gallery-pagination-has-more-value="<%= @has_more %>"
     data-gallery-pagination-total-count-value="<%= @total_count %>">
  <!-- Header with Botanical Flourish -->
  <div class="relative mb-8">
    <!-- Decorative corner flourish (lavender, subtle) -->
    <div class="absolute -top-4 -right-4 w-24 h-24 z-0 pointer-events-none hidden sm:block">
      <svg viewBox="0 0 100 100" class="w-full h-full text-lavender" style="opacity: 0.15;">
        <path d="M95 5 Q70 8, 55 25 Q40 42, 30 65" stroke="currentColor" fill="none" stroke-width="2" stroke-linecap="round"/>
        <path d="M85 8 Q75 2, 70 12 Q80 15, 85 8" fill="currentColor"/>
        <path d="M68 18 Q55 10, 50 22 Q62 28, 68 18" fill="currentColor"/>
        <path d="M52 35 Q38 28, 35 42 Q48 48, 52 35" fill="currentColor"/>
      </svg>
    </div>

    <!-- Breadcrumb Row -->
    <div class="relative mb-4">
      <%= link_to stay_path(@stay), class: "inline-flex items-center gap-1.5 text-sm font-medium text-sage-dark hover:text-sage transition-colors group" do %>
        <svg class="w-4 h-4 group-hover:-translate-x-0.5 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
        </svg>
        <span><%= @stay.title %></span>
      <% end %>
    </div>

    <!-- Main Header Content -->
    <div class="relative flex flex-col sm:flex-row sm:items-start sm:justify-between gap-4">
      <!-- Left Side: Title & Subtitle -->
      <div class="flex-1">
        <h1 class="decorative-heading text-2xl sm:text-3xl font-bold text-brown">Things to Do</h1>
        <p class="text-brown-light mt-2 flex items-center">
          <svg class="w-4 h-4 mr-1.5 text-taupe" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
          </svg>
          <span><%= @stay.city.present? ? @stay.city : @stay.title %><%= ", #{@stay.country}" if @stay.country.present? %></span>
        </p>
      </div>

      <!-- Right Side: Action Button -->
      <div class="flex-shrink-0">
        <%= link_to map_path(focus: @stay.id), class: "btn-primary" do %>
          <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"></path>
          </svg>
          View on Map
        <% end %>
      </div>
    </div>
  </div>

  <% if @places_with_distance&.any? %>
    <!-- Category Filters -->
    <% if @categories.any? %>
      <div class="cozy-card p-4 mb-6 relative overflow-hidden">
        <div class="flex flex-wrap items-center gap-3">
          <p class="text-xs text-brown-light font-medium uppercase tracking-wide">Filter by</p>
          <div class="flex flex-wrap gap-2" role="navigation" aria-label="Category filters">
            <button type="button"
                    data-gallery-filter-target="pill"
                    data-category="all"
                    data-action="click->gallery-filter#filter"
                    class="category-pill active">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path>
              </svg>
              <span>All</span>
            </button>
            <% @categories.each do |category| %>
              <button type="button"
                      data-gallery-filter-target="pill"
                      data-category="<%= category %>"
                      data-action="click->gallery-filter#filter"
                      class="category-pill">
                <%= category_icon(category) %>
                <span><%= category.titleize %></span>
              </button>
            <% end %>
          </div>
          <span data-gallery-filter-target="count" data-gallery-pagination-target="count" class="ml-auto text-xs text-brown-light">
            Showing <%= @places_with_distance.count %> of <%= @total_count %> venues
          </span>
        </div>
      </div>
    <% end %>

    <!-- Venue Grid -->
    <div id="venue-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
      <% place_titles = @places_with_distance.map { |pd| pd.place.name }.compact %>
      <% added_titles = @stay.bucket_list_items.where(title: place_titles).pluck(:title).to_set %>
      <% @places_with_distance.each do |place_data| %>
        <% next if place_data.place.name.blank? %>
        <% added = added_titles.include?(place_data.place.name) %>
        <%= render partial: "galleries/venue_card", locals: { place_data: place_data, added: added } %>
      <% end %>
    </div>

    <!-- Load More Button -->
    <%= turbo_frame_tag "load-more-frame" do %>
      <div class="mt-8 text-center">
        <% if @has_more %>
          <button type="button"
                  data-gallery-pagination-target="loadMoreButton"
                  data-action="click->gallery-pagination#loadMore"
                  class="btn-primary inline-flex items-center gap-2">
            <span data-gallery-pagination-target="buttonText">Load More</span>
            <svg data-gallery-pagination-target="spinner" class="hidden w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
          </button>
        <% else %>
          <p class="text-sm text-brown-light">All <%= @total_count %> venues loaded</p>
        <% end %>
      </div>
    <% end %>

    <!-- Attribution notice (required by Foursquare) -->
    <div class="mt-8 p-4 rounded-2xl bg-cream border border-taupe-light">
      <div class="flex items-start gap-3">
        <svg class="w-5 h-5 text-taupe flex-shrink-0 mt-0.5" viewBox="0 0 24 24" fill="currentColor">
          <path d="M17.724 3H6.104c-.866 0-1.569.713-1.569 1.59v15.398c0 .538.264 1.012.71 1.012.18 0 .37-.058.553-.175l5.83-4.142a1.12 1.12 0 01.652-.206h.053c.237 0 .465.073.652.206l5.877 4.18c.184.117.374.137.553.137.447 0 .711-.474.711-1.012V4.59C20.126 3.713 19.423 3 18.557 3h-.833z"/>
        </svg>
        <div>
          <p class="text-sm text-brown-light">
            Venue data provided by <a href="https://foursquare.com" target="_blank" rel="noopener" class="text-sage-dark hover:underline font-medium">Foursquare</a>.
            Click any venue to view on Foursquare for more details.
          </p>
        </div>
      </div>
    </div>
  <% else %>
    <!-- Empty State (no POIs with photos) -->
    <div class="cozy-card p-12 text-center">
      <div class="w-20 h-20 mx-auto mb-6 rounded-full bg-lavender-light flex items-center justify-center">
        <svg class="w-10 h-10 text-lavender-dark" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
        </svg>
      </div>
      <h2 class="text-xl font-semibold text-brown mb-2">No Venues Found</h2>
      <% if @stay.latitude.blank? || @stay.longitude.blank? %>
        <p class="text-brown-light mb-4">
          This stay doesn't have coordinates yet. Add an address to discover nearby places to visit.
        </p>
        <%= link_to edit_stay_path(@stay), class: "btn-primary inline-flex items-center" do %>
          <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
          </svg>
          Edit Stay
        <% end %>
      <% else %>
        <p class="text-brown-light mb-4">
          We couldn't find any venues with photos near this location. Check back later as new places are added.
        </p>
        <%= link_to stay_path(@stay), class: "btn-primary inline-flex items-center" do %>
          <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
          </svg>
          Back to Stay
        <% end %>
      <% end %>
    </div>
  <% end %>

  <!-- Back Link -->
  <div class="mt-8 pt-8 border-t border-taupe-light">
    <%= link_to stay_path(@stay), class: "text-sage-dark hover:text-sage inline-flex items-center" do %>
      <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
      </svg>
      Back to <%= @stay.title %>
    <% end %>
  </div>
</div>
