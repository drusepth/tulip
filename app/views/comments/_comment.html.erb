<%= turbo_frame_tag dom_id(comment) do %>
  <% is_reply = comment.parent_id.present? %>
  <% is_rating_comment = comment.rating_comment? %>

  <div class="comment <%= is_reply ? 'pt-3' : 'py-5' %>" data-controller="comment-reply" <%= "data-comment-reply-parent-id-value=#{dom_id(parent_comment)}" if is_reply && defined?(parent_comment) %>>
    <% if is_rating_comment %>
      <!-- Rating Comment - Achievement Card Style -->
      <div class="flex gap-4 p-4 rounded-xl bg-gradient-to-br from-sage-light to-cream border border-sage shadow-sm relative overflow-hidden">
        <!-- Decorative botanical corner flourish -->
        <div class="absolute top-0 right-0 w-20 h-20 pointer-events-none" style="opacity: 0.15;">
          <svg viewBox="0 0 64 64" fill="none" class="w-full h-full text-sage-dark">
            <path d="M48 8c-8 4-14 12-16 22-2-10-8-18-16-22 8 4 14 12 16 22 2-10 8-18 16-22z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
            <path d="M56 16c-6 3-10 9-12 16-2-7-6-13-12-16 6 3 10 9 12 16 2-7 6-13 12-16z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
            <circle cx="48" cy="8" r="2" fill="currentColor"/>
            <circle cx="56" cy="16" r="1.5" fill="currentColor"/>
          </svg>
        </div>

        <!-- Avatar -->
        <%= avatar_tag(comment.user, size: 36, html_options: {
          class: "w-9 h-9 ring-2 ring-coral flex-shrink-0"
        }) %>

        <!-- Content -->
        <div class="flex-1 min-w-0">
          <!-- Header with rating info -->
          <div class="flex items-center gap-2 flex-wrap">
            <!-- Checkmark icon -->
            <svg class="w-4 h-4 text-sage-dark" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
            </svg>
            <span class="font-medium text-brown text-sm"><%= comment.user.name %></span>
            <span class="text-xs text-brown-light">loved</span>
            <span class="font-semibold text-sage-dark text-sm"><%= comment.bucket_list_item&.title %></span>
          </div>

          <!-- Star rating display -->
          <div class="mt-2 flex items-center gap-1">
            <% rating_value = comment.bucket_list_item_rating.rating %>
            <% (1..5).each do |star_num| %>
              <% filled = rating_value >= star_num %>
              <% if filled %>
                <svg class="w-6 h-6 text-coral" style="filter: drop-shadow(0 1px 1px rgba(0,0,0,0.1));" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M11.48 3.499a.562.562 0 011.04 0l2.125 5.111a.563.563 0 00.475.345l5.518.442c.499.04.701.663.321.988l-4.204 3.602a.563.563 0 00-.182.557l1.285 5.385a.562.562 0 01-.84.61l-4.725-2.885a.563.563 0 00-.586 0L6.982 20.54a.562.562 0 01-.84-.61l1.285-5.386a.562.562 0 00-.182-.557l-4.204-3.602a.563.563 0 01.321-.988l5.518-.442a.563.563 0 00.475-.345L11.48 3.5z"/>
                </svg>
              <% else %>
                <svg class="w-6 h-6 text-taupe-dark" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M11.48 3.499a.562.562 0 011.04 0l2.125 5.111a.563.563 0 00.475.345l5.518.442c.499.04.701.663.321.988l-4.204 3.602a.563.563 0 00-.182.557l1.285 5.385a.562.562 0 01-.84.61l-4.725-2.885a.563.563 0 00-.586 0L6.982 20.54a.562.562 0 01-.84-.61l1.285-5.386a.562.562 0 00-.182-.557l-4.204-3.602a.563.563 0 01.321-.988l5.518-.442a.563.563 0 00.475-.345L11.48 3.5z"/>
                </svg>
              <% end %>
            <% end %>
            <span class="text-xs text-brown-light ml-2"><%= time_ago_in_words(comment.created_at) %> ago</span>
          </div>

          <!-- Reply action only (no edit/delete for rating comments) -->
          <div class="mt-3 flex items-center text-xs text-taupe">
            <button type="button"
                    class="hover:text-lavender-dark font-medium transition-colors"
                    data-action="click->comment-reply#showForm">
              Reply
            </button>
          </div>
        </div>
      </div>
    <% else %>
      <!-- Regular Comment -->
      <div class="flex gap-4">
        <!-- Avatar -->
        <%= avatar_tag(comment.user, size: is_reply ? 28 : 36, html_options: {
          class: "#{is_reply ? 'w-7 h-7' : 'w-9 h-9'} ring-2 ring-lavender-light flex-shrink-0"
        }) %>

        <!-- Content -->
        <div class="flex-1 min-w-0">
          <!-- Header -->
          <div class="flex items-center gap-2 flex-wrap">
            <span class="font-medium text-brown text-sm"><%= comment.user.name %></span>
            <span class="text-xs text-taupe">·</span>
            <span class="text-xs text-taupe"><%= time_ago_in_words(comment.created_at) %> ago</span>
            <% if comment.edited? %>
              <span class="text-xs text-taupe italic">(edited)</span>
            <% end %>
          </div>

          <!-- Body -->
          <div class="mt-1.5 text-brown text-sm whitespace-pre-wrap break-words leading-relaxed"><%= comment.body %></div>

          <!-- Actions - always visible with dot separators -->
          <div class="mt-2.5 flex items-center text-xs text-taupe">
            <button type="button"
                    class="hover:text-lavender-dark font-medium transition-colors"
                    data-action="click->comment-reply#showForm">
              Reply
            </button>

            <% if comment.editable_by?(current_user) %>
              <span class="mx-2">·</span>
              <%= link_to edit_stay_comment_path(stay, comment),
                          class: "hover:text-sage-dark transition-colors",
                          data: { turbo_stream: true } do %>
                Edit
              <% end %>
              <span class="mx-2">·</span>
              <%= button_to stay_comment_path(stay, comment),
                            method: :delete,
                            class: "hover:text-rose-dark transition-colors",
                            data: { turbo_confirm: "Delete this comment?", turbo_stream: true } do %>
                Delete
              <% end %>
            <% end %>
          </div>
        </div>
      </div>
    <% end %>

    <!-- Replies - gentle indentation -->
    <% unless is_reply %>
      <% if comment.replies.any? %>
        <div class="mt-3 ml-13 space-y-0" id="<%= dom_id(comment, :replies) %>">
          <% comment.replies.ordered.each do |reply| %>
            <%= render "comments/comment", comment: reply, stay: stay, parent_comment: comment %>
          <% end %>
        </div>
      <% else %>
        <div class="hidden mt-3 ml-13 space-y-0" id="<%= dom_id(comment, :replies) %>">
        </div>
      <% end %>

      <!-- Inline Reply Form (after replies, only on top-level comments) -->
      <div data-comment-reply-target="form" class="hidden mt-3 ml-13">
        <%= render "comments/reply_form", stay: stay, parent: comment %>
      </div>
    <% end %>
  </div>
<% end %>
